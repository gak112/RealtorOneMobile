<ion-header>
    <ion-toolbar>
        <ion-icon name="chevron-back-outline" class="icon-close" (click)="dismiss()"></ion-icon>
        <ion-title>
            Specfications
        </ion-title>
    </ion-toolbar>
</ion-header>
<ion-content class="ion-padding">
    <form style="display: none;">
        <div class="div-form">
            <div class="div-flex">
                <ion-input type="text" mode="md" label="Specfication Title" label-placement="floating" fill="outline"
                    placeholder="Enter Specfication Title"></ion-input>
                <ion-button color="warning" (click)="addSection()">+&nbsp;Add</ion-button>
            </div>
            <div class="div-specification-display">
                <div class="div-title-delete">
                    <ion-label class="spec-title">Specfication Title</ion-label>
                    <ion-icon name="trash-outline" class="spec-delete"></ion-icon>
                </div>
                <div class="div-spec-inputs">
                    <div class="div-formgroup">
                        <ion-input type="text" mode="md" label="Keyword" label-placement="floating" fill="outline"
                            placeholder="Enter Keyword"></ion-input>
                    </div>
                    <div class="div-formgroup">
                        <ion-textarea type="text" mode="md" label="Value" label-placement="floating" fill="outline"
                            placeholder="Enter Value" rows="5" style="height: auto;"></ion-textarea>
                    </div>
                    <ion-button style="margin-top: 10px;" expand="block" color="primary">
                        <span class="spinner-border spinner-border-sm"></span>
                        Add</ion-button>
                </div>
            </div>
            <div>
                <div class="div-specification-display">
                    <ion-label class="ion-label-main" style="border-radius: var(--border-radius-4);">Kitchen
                        Rooms</ion-label>
                    <div style="padding: 10px;">
                        @for (spec of [0,1,2,3,4,5,6,7,8,9]; track spec) {
                        <div class="div-spec-keys-values">
                            <div class="div-specification-sub">
                                <ion-label class="ion-label-title" contenteditable="true">Kitchen Rooms</ion-label>
                                <ion-label class="ion-label-title" style="text-align: center;"
                                    contenteditable="true">3</ion-label>
                            </div>
                            <ion-icon name="trash-outline" class="spec-delete"></ion-icon>
                        </div>
                        }
                    </div>
                    <div class="div-edit-delete">
                        <ion-icon name="trash-outline"></ion-icon>
                        <ion-label>Delete</ion-label>
                    </div>
                </div>
            </div>
        </div>
    </form>


    <form [formGroup]="specificationsForm">
        <div class="div-flex">
            <ion-input type="text" mode="md" label="Specification Title" label-placement="floating" fill="outline"
                placeholder="Enter Specification Title" [formControl]="newTitle">
            </ion-input>

            <ion-button color="warning" (click)="addSection()" [disabled]="newTitle.invalid">
                +&nbsp;Add
            </ion-button>
        </div>

        <!-- Title validation hint -->
        @if (newTitle.touched && newTitle.invalid) {
        <div style="font-size:.8rem; color: var(--ion-color-danger); margin-top:.25rem;">
            @if (newTitle.errors?.['required']) { <span>Title is required.</span> }
            @else if (newTitle.errors?.['minlength']) { <span>Minimum 3 characters.</span> }
        </div>
        }

        <!-- Existing Specifications -->
        <div formArrayName="sections">
            @for (sec of sections.controls; track trackSection($index); let i = $index) {
            <div class="div-specification-display" [formGroupName]="i">
                <div class="div-title-delete">
                    <ion-label class="spec-title">
                        {{ sectionAt(i).controls.title.value }}
                    </ion-label>
                    <ion-icon name="trash-outline" class="spec-delete" (click)="removeSection(i)"></ion-icon>
                </div>

                <!-- New item inputs for this section -->
                <div class="div-spec-inputs">
                    <div formGroupName="newItem">
                        <div class="div-formgroup">
                            <ion-input type="text" mode="md" label="Keyword" label-placement="floating" fill="outline"
                                placeholder="Enter Keyword" formControlName="key">
                            </ion-input>
                            @if (sectionAt(i).controls.newItem.controls.key.touched &&
                            sectionAt(i).controls.newItem.controls.key.invalid) {
                            <div style="font-size:.75rem; color: var(--ion-color-danger); margin-top:.25rem;">
                                Keyword is required.
                            </div>
                            }
                        </div>

                        <div class="div-formgroup">
                            <ion-textarea mode="md" label="Value" label-placement="floating" fill="outline"
                                placeholder="Enter Value" rows="4" style="height:auto;" formControlName="value">
                            </ion-textarea>
                            @if (sectionAt(i).controls.newItem.controls.value.touched &&
                            sectionAt(i).controls.newItem.controls.value.invalid) {
                            <div style="font-size:.75rem; color: var(--ion-color-danger); margin-top:.25rem;">
                                Value is required.
                            </div>
                            }
                        </div>

                        <ion-button expand="block" color="primary" (click)="addItem(i)"
                            [disabled]="sectionAt(i).controls.newItem.invalid">
                            Add
                        </ion-button>
                    </div>
                </div>
            </div>
            }

            @for (sec of sections.controls; track trackSection($index); let i = $index) {
            <div class="div-specification-display" [formGroupName]="i">
                <div class="div-title-delete"
                    style="background: var(--background-main); border-top-left-radius: 12px; border-top-right-radius: 12px;">
                    <ion-label class="ion-label-main">
                        {{ sectionAt(i).controls.title.value }}
                    </ion-label>
                    <ion-icon name="trash-outline" class="spec-delete" (click)="removeSection(i)"></ion-icon>
                </div>

                <!-- Items list -->
                <div style="padding: 10px;" formArrayName="items">
                    @for (item of sectionAt(i).controls.items.controls; track trackItem($index); let j = $index) {
                    <div class="div-spec-keys-values" [formGroupName]="j">
                        <div class="div-specification-sub">
                            <ion-label class="ion-label-title" style="font-weight:500;">
                                {{ item.controls.key.value }}
                            </ion-label>
                            <ion-label class="ion-label-title">
                                {{ item.controls.value.value }}
                            </ion-label>
                        </div>
                        <ion-icon name="trash-outline" class="spec-delete" (click)="removeItem(i, j)"></ion-icon>
                    </div>
                    }
                </div>
            </div>
            }
        </div>
    </form>

</ion-content>
<ion-footer>
    <ion-button expand="block" color="warning" (click)="submit()">
        <span class="spinner-border spinner-border-sm"></span>
        Submit</ion-button>
</ion-footer>