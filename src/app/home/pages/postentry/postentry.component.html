<ion-header>
  <ion-toolbar style="--border-width: 0">
    <ion-icon name="chevron-back-outline" class="icon-close" (click)="dismiss()" />
    <ion-title>{{ headerTitle() }}</ion-title>
  </ion-toolbar>

  @if (pageError()) {
  <div style="background:#fee2e2;color:#7f1d1d;padding:8px 12px;font-size:13px;">
    {{ pageError() }}
  </div>
  }
</ion-header>

<ion-content class="ion-padding">
  <form [formGroup]="postEntryForm" (ngSubmit)="submit()" novalidate>
    <div style="margin-bottom:16px;">
      <ion-label>Property Type</ion-label>
      <div style="display:flex;gap:12px;align-items:center;">
        <span class="span-type">{{ saleTypeSig() }}</span>
        <ion-icon name="arrow-forward-outline" style="font-size:16px;color:var(--color-skyblue);" />
        <span class="span-type">{{ categorySig() }}</span>
      </div>
    </div>

    <div class="div-form-main">
      <!-- Title -->
      <div class="div-formgroup">
        <ion-input type="text" mode="md" label="Property Title" label-placement="floating" fill="outline"
          placeholder="Enter Property Title" autocomplete="off" autocapitalize="sentences"
          formControlName="propertyTitle" />
      </div>

      @if (categorySig() === 'residential') {
      <!-- House Type -->
      <div class="div-formgroup">
        <ion-select mode="md" label="Select House Type" label-placement="floating" fill="outline"
          formControlName="houseType">
          <ion-select-option value="Apartment">Apartment</ion-select-option>
          <ion-select-option value="Individual House/Villa">Individual House/Villa</ion-select-option>
          <ion-select-option value="Independent / Builder Floor">Independent / Builder Floor</ion-select-option>
          <ion-select-option value="Farm House">Farm House</ion-select-option>
          <ion-select-option value="Service Apartment">Service Apartment</ion-select-option>
          <ion-select-option value="Other">Other</ion-select-option>
        </ion-select>
      </div>

      <!-- Old/New -->
      <div class="div-formgroup">
        <ion-select mode="md" label="Select Old/New House" label-placement="floating" fill="outline"
          formControlName="houseCondition">
          <ion-select-option value="Old Houses">Old Houses</ion-select-option>
          <ion-select-option value="New Houses">New Houses</ion-select-option>
        </ion-select>
      </div>

      @if (ctrl('houseCondition').value === 'Old Houses') {
      <!-- Rooms + counts -->
      <div class="div-formgroup">
        <ion-input type="number" inputmode="numeric" mode="md" label="No of Rooms" label-placement="floating"
          fill="outline" placeholder="Enter No of Rooms" formControlName="rooms" />
      </div>

      <div class="div-grid">
        <ion-input type="number" mode="md" label="Bathrooms" label-placement="floating" fill="outline"
          placeholder="Enter Bathrooms" formControlName="toilets" />
        <ion-input type="number" mode="md" label="Pooja Room" label-placement="floating" fill="outline"
          placeholder="Enter Pooja Room" formControlName="poojaRoom" />
        <ion-input type="number" mode="md" label="Living/Dining" label-placement="floating" fill="outline"
          placeholder="Enter Living/Dining" formControlName="livingDining" />
        <ion-input type="number" mode="md" label="Kitchen" label-placement="floating" fill="outline"
          placeholder="Enter Kitchen" formControlName="kitchen" />
      </div>
      }

      @if (ctrl('houseCondition').value === 'New Houses') {
      <!-- BHK + Facing -->
      <div class="div-formgroup">
        <ion-select mode="md" label="Select BHK Type" label-placement="floating" fill="outline"
          formControlName="bhkType">
          <ion-select-option value="1BHK">1BHK</ion-select-option>
          <ion-select-option value="2BHK">2BHK</ion-select-option>
          <ion-select-option value="3BHK">3BHK</ion-select-option>
          <ion-select-option value="4BHK">4BHK</ion-select-option>
          <ion-select-option value="5BHK">5BHK</ion-select-option>
          <ion-select-option value="+5BHK">+5BHK</ion-select-option>
        </ion-select>
      </div>

      <div class="div-formgroup">
        <ion-select mode="md" label="Select House Facing" label-placement="floating" fill="outline"
          formControlName="houseFacingType">
          <ion-select-option value="North Facing">North Facing</ion-select-option>
          <ion-select-option value="South Facing">South Facing</ion-select-option>
          <ion-select-option value="East Facing">East Facing</ion-select-option>
          <ion-select-option value="West Facing">West Facing</ion-select-option>
          <ion-select-option value="North-East Facing">North-East Facing</ion-select-option>
          <ion-select-option value="North-West Facing">North-West Facing</ion-select-option>
          <ion-select-option value="South-East Facing">South-East Facing</ion-select-option>
          <ion-select-option value="South-West Facing">South-West Facing</ion-select-option>
        </ion-select>
      </div>
      }
      }

      @if (categorySig() === 'residential' || categorySig() === 'commercial') {
      <div class="div-formgroup">
        <ion-select mode="md" label="Select Furnishing Type" label-placement="floating" fill="outline"
          formControlName="furnishingType">
          <ion-select-option value="Fully-Furnished">Fully-Furnished</ion-select-option>
          <ion-select-option value="Semi-Furnished">Semi-Furnished</ion-select-option>
          <ion-select-option value="Unfurnished">Unfurnished</ion-select-option>
        </ion-select>
      </div>
      }

      @if (categorySig() === 'commercial') {
      <div class="div-formgroup">
        <ion-select mode="md" label="Commercial Type" label-placement="floating" fill="outline"
          formControlName="commercialType">
          <ion-select-option value="Retail">Retail</ion-select-option>
          <ion-select-option value="Office">Office</ion-select-option>
          <ion-select-option value="Warehouse">Warehouse</ion-select-option>
          <ion-select-option value="Factory">Factory</ion-select-option>
          <ion-select-option value="Industriy">Industriy</ion-select-option>
          <ion-select-option value="Hospitality">Hospitality</ion-select-option>
          <ion-select-option value="Land">Land</ion-select-option>
          <ion-select-option value="Other">Other</ion-select-option>
        </ion-select>
      </div>

      <div class="div-formgroup">
        <ion-select mode="md" label="Commercial Sub Type" label-placement="floating" fill="outline"
          formControlName="commercialSubType">
          <ion-select-option value="Shopping Mall">Complex</ion-select-option>
          <ion-select-option value="Individual">Individual</ion-select-option>
        </ion-select>
      </div>
      }

      <!-- Plot area + units -->
      <div class="div-formgroup" style="display:flex;gap:12px;align-items:center;">
        <ion-input type="number" inputmode="numeric" mode="md" label="Plot Area" label-placement="floating"
          fill="outline" placeholder="Enter Plot Area" formControlName="PlotArea" />

        <ion-select mode="md" label="Units" label-placement="floating" fill="outline" style="min-width:150px;"
          formControlName="plotAreaUnits">
          <ion-select-option value="Acre">Acre</ion-select-option>
          <ion-select-option value="Feet">Feet</ion-select-option>
          <ion-select-option value="Yard">Yard</ion-select-option>
          <ion-select-option value="Mtr">Mtr</ion-select-option>
          <ion-select-option value="Sq Feet">Sq Feet</ion-select-option>
          <ion-select-option value="Sq Yard">Sq Yard</ion-select-option>
          <ion-select-option value="Sq Mtr">Sq Mtr</ion-select-option>
        </ion-select>
      </div>

      <!-- Builtup area + units -->
      <div class="div-formgroup" style="display:flex;gap:12px;align-items:center;">
        <ion-input type="number" inputmode="numeric" mode="md" label="Builtup Area" label-placement="floating"
          fill="outline" placeholder="Enter Builtup Area" formControlName="builtUpArea" />

        <ion-select mode="md" label="Units" label-placement="floating" fill="outline" style="min-width:150px;"
          formControlName="builtUpAreaUnits">
          <ion-select-option value="Acre">Acre</ion-select-option>
          <ion-select-option value="Feet">Feet</ion-select-option>
          <ion-select-option value="Yard">Yard</ion-select-option>
          <ion-select-option value="Mtr">Mtr</ion-select-option>
          <ion-select-option value="Sq Feet">Sq Feet</ion-select-option>
          <ion-select-option value="Sq Yard">Sq Yard</ion-select-option>
          <ion-select-option value="Sq Mtr">Sq Mtr</ion-select-option>
        </ion-select>
      </div>

      @if (
      categorySig() === 'plots' ||
      categorySig() === 'agriculturalLands' ||
      (categorySig() === 'residential' && (ctrl('houseType').value === 'Individual House/Villa' ||
      ctrl('houseType').value === 'Farm House')) ||
      (categorySig() === 'commercial' && ctrl('commercialSubType').value === 'Individual')
      ) {
      <!-- Common Facing Units -->
      <div class="div-formgroup">
        <ion-select mode="md" label="Facing Units" label-placement="floating" fill="outline"
          formControlName="facingUnits">
          <ion-select-option value="Acre">Acre</ion-select-option>
          <ion-select-option value="Feet">Feet</ion-select-option>
          <ion-select-option value="Yard">Yard</ion-select-option>
          <ion-select-option value="Mtr">Mtr</ion-select-option>
          <ion-select-option value="Sq Feet">Sq Feet</ion-select-option>
          <ion-select-option value="Sq Yard">Sq Yard</ion-select-option>
          <ion-select-option value="Sq Mtr">Sq Mtr</ion-select-option>
        </ion-select>
      </div>

      <!-- Sides -->
      <div class="div-formgroup">
        <div style="display:flex;align-items:center;gap:12px;">
          <ion-input type="text" mode="md" label="North Dimensions" label-placement="floating" fill="outline"
            placeholder="Enter North Dimensions" formControlName="northFacing" />
          <ion-input type="number" inputmode="numeric" mode="md" label="Size" label-placement="floating" fill="outline"
            placeholder="Enter Size" style="width:150px;" formControlName="northSize" />
          <div class="div-label"><ion-label>{{ unitShort() }}</ion-label></div>
        </div>
      </div>

      <div class="div-formgroup">
        <div style="display:flex;align-items:center;gap:12px;">
          <ion-input type="text" mode="md" label="South Dimensions" label-placement="floating" fill="outline"
            placeholder="Enter South Dimensions" formControlName="southFacing" />
          <ion-input type="number" inputmode="numeric" mode="md" label="Size" label-placement="floating" fill="outline"
            placeholder="Enter Size" style="width:150px;" formControlName="southSize" />
          <div class="div-label"><ion-label>{{ unitShort() }}</ion-label></div>
        </div>
      </div>

      <div class="div-formgroup">
        <div style="display:flex;align-items:center;gap:12px;">
          <ion-input type="text" mode="md" label="East Dimensions" label-placement="floating" fill="outline"
            placeholder="Enter East Dimensions" formControlName="eastFacing" />
          <ion-input type="number" inputmode="numeric" mode="md" label="Size" label-placement="floating" fill="outline"
            placeholder="Enter Size" style="width:150px;" formControlName="eastSize" />
          <div class="div-label"><ion-label>{{ unitShort() }}</ion-label></div>
        </div>
      </div>

      <div class="div-formgroup">
        <div style="display:flex;align-items:center;gap:12px;">
          <ion-input type="text" mode="md" label="West Dimensions" label-placement="floating" fill="outline"
            placeholder="Enter West Dimensions" formControlName="westFacing" />
          <ion-input type="number" inputmode="numeric" mode="md" label="Size" label-placement="floating" fill="outline"
            placeholder="Enter Size" style="width:150px;" formControlName="westSize" />
          <div class="div-label"><ion-label>{{ unitShort() }}</ion-label></div>
        </div>
      </div>
      }

      @if (categorySig() === 'residential' || categorySig() === 'commercial') {
      <!-- Floor -->
      <div class="div-formgroup">
        <ion-select mode="md" label="Select Floor" label-placement="floating" fill="outline" formControlName="floor">
          @for (f of floors; track f) {
          <ion-select-option [value]="f">{{ f }}</ion-select-option>
          }
        </ion-select>
      </div>
      }

      @if (categorySig() === 'residential' || categorySig() === 'commercial') {
      <!-- Amenities -->
      <div class="div-formgroup"
        style="display:flex;align-items:center;gap:8px;justify-content:space-between;border:var(--border-ddd);border-radius:8px;padding:8px 12px;">
        <ion-label style="margin:0;font-size:16px;">Amenities</ion-label>
        <ion-button size="small" color="warning" (click)="openAmenities()">
          <ion-icon slot="start" name="add" /> Add
        </ion-button>
      </div>

      @if (amenities().length > 0) {
      <div class="div-amenities">
        @for (a of amenities(); track a; let i = $index) {
        <span class="badge-amenity">
          {{ a }}
          <ion-icon name="close" (click)="removeAmenity(i)" style="font-size:14px;color:#fff;" />
        </span>
        }
      </div>
      }
      }

      @if (categorySig() === 'residential' || categorySig() === 'commercial') {
      <div class="div-formgroup">
        <ion-input type="text" mode="md" label="Age of Property" label-placement="floating" fill="outline"
          placeholder="Enter Age of Property" formControlName="ageOfProperty" />
      </div>
      }

      @if (saleTypeSig() === 'rent') {
      <!-- Rent -->
      <div class="div-formgroup">
        <div style="display:flex;align-items:center;gap:12px;">
          <ion-input type="number" inputmode="numeric" mode="md" label="Rent Amount (₹)" label-placement="floating"
            fill="outline" placeholder="Enter Rent Amount" formControlName="priceOfRent" />
          <ion-select mode="md" label="Rent Type" label-placement="floating" fill="outline" style="width:150px;"
            formControlName="priceOfRentType">
            <ion-select-option value="Monthly">Monthly</ion-select-option>
            <ion-select-option value="Yearly">Yearly</ion-select-option>
          </ion-select>
        </div>
      </div>
      }

      @if (saleTypeSig() === 'sale') {
      <!-- Sale Price -->
      <div class="div-formgroup">
        <ion-input type="number" inputmode="numeric" mode="md" label="Sale Price (₹)" label-placement="floating"
          fill="outline" placeholder="Enter Sale Price" formControlName="priceOfSale" />
      </div>
      }

      @if (categorySig() === 'commercial' && saleTypeSig() === 'rent') {
      <div class="div-formgroup">
        <ion-input type="number" inputmode="numeric" mode="md" label="Security Deposit (₹)" label-placement="floating"
          fill="outline" placeholder="Enter Security Deposit" formControlName="securityDeposit" />
      </div>
      }

      <!-- Address -->
      <div class="div-formgroup">
        <div (click)="openLocation()">
          <ion-textarea mode="md" label="Address" label-placement="floating" fill="outline"
            placeholder="Type or auto-fill address" rows="3" style="height:auto;"
            formControlName="addressOfProperty" />
        </div>
        <div class="div-detect-location">
          <ion-img src="assets/img/gps.png" class="img-detect-location" />
          <span class="span-detect-location">Detect my location</span>
        </div>
      </div>

      <!-- Description -->
      <div class="div-formgroup">
        <ion-textarea mode="md" label="Description" label-placement="floating" fill="outline"
          placeholder="Enter Description" rows="5" style="height:auto;" formControlName="description" />
      </div>

      <div class="div-formgroup">
        <ion-select mode="md" label="Availability Status" label-placement="floating" fill="outline"
          formControlName="availabilityStatus">
          <ion-select-option value="Ready to move">Ready to move</ion-select-option>
          <ion-select-option value="Under construction">Under construction</ion-select-option>
        </ion-select>
      </div>

      <!-- Negotiable -->
      <div class="div-negotiable">
        <ion-label class="label-negotiable">Negotiable</ion-label>
        <ion-checkbox mode="md" formControlName="negotiable" />
      </div>

      <!-- Property Images (max 3) -->
      <div class="div-upload">
        <ion-label class="upload-label">Upload images (max 3)</ion-label>

        <div class="div-add" (click)="openImageSource()">
          <ion-icon name="camera" class="icon-upload" />
          <ion-label class="label-add">Add Images</ion-label>
          <span class="label-span">Camera • Gallery</span>
        </div>

        @if (ucBusy()) {
        <div style="font-size:12px;color:#666;margin-top:8px;">Uploading…</div>
        }
      </div>

      @if (images().length > 0) {
      <div class="div-venture-images">
        @for (url of images(); let i = $index; track url) {
        <div class="div-uploading">
          <ion-icon name="trash-outline" (click)="removeImageAt(i)" />
          <ion-img [src]="url" loading="lazy" />
        </div>
        }
      </div>
      }

      <!-- VIDEO (Mux only) -->
      <div class="div-upload">
        <ion-label class="upload-label">Property video (Mux)</ion-label>

        <!-- File picker -->
        <div class="div-add" (click)="videoFileInput.click()">
          <ion-icon name="cloud-upload-outline" class="icon-upload" />
          <ion-label class="label-add">Choose video</ion-label>
          <span class="label-span">.mp4 / .webm / .mov • ≤ 20s</span>
          <input #videoFileInput type="file" accept="video/mp4,video/webm,video/quicktime" hidden
            (change)="handleMuxVideoSelect($event)" />
        </div>

        <!-- Upload progress/status -->
        @if (videoBusy()) {
        <div style="margin-top:8px;font-size:12px;color:#555;">
          {{ videoStatus() }}
        </div>
        <ion-progress-bar [value]="videoProgress()" color="warning" style="margin-top:4px;" />
        }

        <!-- Player once playback id exists -->
        @if (muxPlaybackId()) {
        <div class="div-venture-images" style="margin-top:12px;">
          <div class="div-uploading" style="width:auto;">
            <ion-icon name="trash-outline" (click)="clearMuxVideo()" />
            <mux-player style="width:100%;max-height:360px;" [attr.playback-id]="muxPlaybackId()"
              [attr.poster]="muxPosterUrl()" stream-type="on-demand" playsinline controls />
          </div>
        </div>
        }
      </div>
    </div>
  </form>
</ion-content>

<ion-footer>
  <ion-button class="ion-button-settings" mode="ios" expand="block" color="warning" [disabled]="loading()"
    (click)="submit()">
    {{ actionLabel() }}
  </ion-button>
</ion-footer>